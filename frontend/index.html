<!DOCTYPE HTML>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Princesas de Disney</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <style>
        .hidden {
            display: none;
        }
        .error-message {
            color: red;
            font-size: 0.8em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>Elige un usuario para jugar</h1>
    <div id="user-grid" class="user-grid">
        <div class="user-card">
            <img src="./img/perfiluser.png" alt="Rocio">
            <div class="user-info">
                <h2 class="user-name">Rocio</h2>
                <div class="user-details">
                    <p>PrincessCoins: 1500</p>
                    <p>Princesas: 7</p>
                    <p>Edad: 20</p>
                </div>
            </div>
            <button class="select-button" onclick="selectUser(this)">Seleccionar</button>
        </div>
        <div class="user-card">
            <img src="./img/perfiluser.png" alt="Nahuel">
            <div class="user-info">
                <h2 class="user-name">Nahuel</h2>
                <div class="user-details">
                    <p>PrincessCoins: 750</p>
                    <p>Princesas: 5</p>
                    <p>Edad: 21</p>
                </div>
            </div>
            <button class="select-button" onclick="selectUser(this)">Seleccionar</button>
        </div>
        <div class="user-card">
            <img src="./img/perfiluser.png" alt="Oswaldo">
            <div class="user-info">
                <h2 class="user-name">Oswaldo</h2>
                <div class="user-details">
                    <p>PrincessCoins: 500</p>
                    <p>Princesas: 3</p>
                    <p>Edad: 20</p>
                </div>
            </div>
            <button class="select-button" onclick="selectUser(this)">Seleccionar</button>
        </div>
        <div class="user-card">
            <img src="./img/perfiladmin.png" alt="Admin" onerror="this.src='https://via.placeholder.com/100'" >//que es eso de onerror????
            <div class="user-info">
                <h2 class="user-name">Admin</h2>
                <div class="user-details">
                    <p>PrincessCoins: 10000</p>
                    <p>Princesas: 10000</p>
                    <p>Edad: 35</p>
                </div>
            </div>
            <button class="select-button" onclick="selectUser(this)">Seleccionar</button>
        </div>
        <div class="add-user-card" id="addUserCard">
            <span class="add-user-icon">+</span>
            <p>Agregar Nuevo Usuario</p>
        </div>
    </div>

    <div id="newUserForm" class="hidden">
        <div class="container is-max-desktop">
            <div class="field">
                <label class="label">Nombre</label>
                <div class="control">
                    <input id="nombre" class="input" type="text" placeholder="Nombre">
                </div>
            </div>
            <div class="field">
                <label class="label">Edad</label>
                <div class="control">
                    <input id="edad" class="input" type="number" placeholder="Edad" min="1">
                </div>
                <p id="edadError" class="error-message hidden">La edad debe ser un número positivo mayor que 0.</p>
            </div>
            <div class="field">
                <label class="label">Princesa Favorita</label>
                <div class="control">
                    <input id="princesa_fav" class="input" type="text" placeholder="Princesa Favorita">
                </div>
            </div>
            <div class="field is-grouped is-grouped-centered">
                <p class="control">
                    <button class="button is-primary" onclick="crearUsuario()">
                        Guardar
                    </button>
                </p>
                <p class="control">
                    <a class="button is-light" onclick="vaciarForm()">
                        Borrar
                    </a>
                </p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('navbar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('navbar-container').innerHTML = data;
                    // Inicializar el navbar-burger
                    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
                    $navbarBurgers.forEach(el => {
                        el.addEventListener('click', () => {
                            const target = el.dataset.target;
                            const $target = document.getElementById(target);
                            el.classList.toggle('is-active');
                            $target.classList.toggle('is-active');
                        });
                    });
                });

            const addUserCard = document.getElementById('addUserCard');
            const newUserForm = document.getElementById('newUserForm');

            addUserCard.addEventListener('click', () => {
                addUserCard.classList.add('hidden');
                newUserForm.classList.remove('hidden');
            });
        });

        function crearUsuario() {
            let nombre = document.getElementById('nombre').value;
            let edad = document.getElementById('edad').value;
            let princesa_fav = document.getElementById('princesa_fav').value;

            // Validar la edad
            if (parseInt(edad) <= 0) {
                document.getElementById('edadError').classList.remove('hidden');
                return;
            } else {
                document.getElementById('edadError').classList.add('hidden');
            }

            let usuario = {
                nombre: nombre,
                edad: parseInt(edad),
                princesa_fav: princesa_fav,
                princessCoins: 0,
                princessAttachments: 1
            }
            fetch('http://localhost:3000/api/v1/usuarios', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(usuario)
            })
            .then(response => {
                if(response.status === 201){
                    alert('Usuario creado con éxito');
                    vaciarForm();
                    // location.reload(); // Recargar la página?
                    window.location.href = 'pag_principal.html'; // Redirigir a la página principal
                    localStorage.setItem('nombreUsuario', nombre);

                } else {
                    alert('Error al crear el usuario');
                }
            })
        }

        function vaciarForm() {
            document.getElementById('nombre').value = '';
            document.getElementById('edad').value = '';
            document.getElementById('princesa_fav').value = '';
            document.getElementById('edadError').classList.add('hidden');
            
            // After clearing the form, hide it and show the add user card again
            document.getElementById('newUserForm').classList.add('hidden');
            document.getElementById('addUserCard').classList.remove('hidden');
        }

        function selectUser(button) {
            const tarjetaUsuario = button.closest('.user-card');
            const nombreUsuario = tarjetaUsuario.querySelector('.user-name').textContent;
            localStorage.setItem('nombreUsuario', nombreUsuario);
            window.location.href = 'pag_principal.html'; // Redirigir a la página principal
        }
    </script>
</body>
</html>